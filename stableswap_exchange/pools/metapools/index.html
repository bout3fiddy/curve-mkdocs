<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=CurveFi><link href=https://bout3fiddy.github.io/curve-mkdocs/stableswap_exchange/pools/metapools/ rel=canonical><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.2.3, mkdocs-material-8.2.6"><title>Metapools - Curve Docs</title><link rel=stylesheet href=../../../assets/stylesheets/main.9d5733d3.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.e6a45f82.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../css/timeago.css><link rel=stylesheet href=../../../stylesheets/extra.css><script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=red> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#overview class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title="Curve Docs" class="md-header__button md-logo" aria-label="Curve Docs" data-md-component=logo> <img src=../../../images/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Curve Docs </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Metapools </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=red aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=red aria-label="Switch to dark mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08z"/></svg> </a> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/bout3fiddy/curve-mkdocs.git/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> bout3fiddy/curve-mkdocs </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="Curve Docs" class="md-nav__button md-logo" aria-label="Curve Docs" data-md-component=logo> <img src=../../../images/logo.png alt=logo> </a> Curve Docs </label> <div class=md-nav__source> <a href=https://github.com/bout3fiddy/curve-mkdocs.git/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> bout3fiddy/curve-mkdocs </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1 checked> <label class=md-nav__link for=__nav_1> Stableswap Exchange <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Stableswap Exchange" data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Stableswap Exchange </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../overview/ class=md-nav__link> Overview </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_2 type=checkbox id=__nav_1_2 checked> <label class=md-nav__link for=__nav_1_2> Pools <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Pools data-md-level=2> <label class=md-nav__title for=__nav_1_2> <span class="md-nav__icon md-icon"></span> Pools </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../plain_pools/ class=md-nav__link> Plain Pools </a> </li> <li class=md-nav__item> <a href=../lending_pools/ class=md-nav__link> Lending Pools </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Metapools <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Metapools </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#overview class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=#pool-info-methods class=md-nav__link> Pool Info Methods </a> <nav class=md-nav aria-label="Pool Info Methods"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#stableswapbase_coins class=md-nav__link> StableSwap.base_coins </a> </li> <li class=md-nav__item> <a href=#stableswapcoins class=md-nav__link> StableSwap.coins </a> </li> <li class=md-nav__item> <a href=#stableswapbase_pool class=md-nav__link> StableSwap.base_pool </a> </li> <li class=md-nav__item> <a href=#stableswapbase_virtual_price class=md-nav__link> StableSwap.base_virtual_price </a> </li> <li class=md-nav__item> <a href=#stableswapbase_cache_update class=md-nav__link> StableSwap.base_cache_update() </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#exchange-methods class=md-nav__link> Exchange Methods </a> <nav class=md-nav aria-label="Exchange Methods"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#stableswapexchange class=md-nav__link> StableSwap.exchange </a> </li> <li class=md-nav__item> <a href=#stableswapexchange_underlying class=md-nav__link> StableSwap.exchange_underlying </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../admin_pool_settings/ class=md-nav__link> Admin Controls </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_3 data-md-state=indeterminate type=checkbox id=__nav_1_3 checked> <label class=md-nav__link for=__nav_1_3> Liquidity Pool Tokens <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Liquidity Pool Tokens" data-md-level=2> <label class=md-nav__title for=__nav_1_3> <span class="md-nav__icon md-icon"></span> Liquidity Pool Tokens </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../lp_tokens/overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../lp_tokens/curve_token_v1/ class=md-nav__link> Curve Token V1 </a> </li> <li class=md-nav__item> <a href=../../lp_tokens/curve_token_v2/ class=md-nav__link> Curve Token V2 </a> </li> <li class=md-nav__item> <a href=../../lp_tokens/curve_token_v3/ class=md-nav__link> Curve Token V3 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_4 data-md-state=indeterminate type=checkbox id=__nav_1_4 checked> <label class=md-nav__link for=__nav_1_4> Deposit Contracts <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Deposit Contracts" data-md-level=2> <label class=md-nav__title for=__nav_1_4> <span class="md-nav__icon md-icon"></span> Deposit Contracts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../deposit_contracts/overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../deposit_contracts/lending_pool_deposits/ class=md-nav__link> Lending Pool Deposits </a> </li> <li class=md-nav__item> <a href=../../deposit_contracts/metapool_deposits/ class=md-nav__link> Metapool Deposits </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_5 data-md-state=indeterminate type=checkbox id=__nav_1_5 checked> <label class=md-nav__link for=__nav_1_5> Cross Asset Swaps <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Cross Asset Swaps" data-md-level=2> <label class=md-nav__title for=__nav_1_5> <span class="md-nav__icon md-icon"></span> Cross Asset Swaps </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cross_asset_swaps/overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../cross_asset_swaps/synthswap_exchange/ class=md-nav__link> SynthSwap </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 data-md-state=indeterminate type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2> Cryptoswap Exchange <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Cryptoswap Exchange" data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Cryptoswap Exchange </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cryptoswap_exchange/overview/ class=md-nav__link> Overview </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 data-md-state=indeterminate type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3> Curve DAO <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Curve DAO" data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Curve DAO </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../curve_dao/overview/ class=md-nav__link> Overview </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 data-md-state=indeterminate type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4> Registry <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Registry data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Registry </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../registry/overview/ class=md-nav__link> Overview </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 data-md-state=indeterminate type=checkbox id=__nav_5 checked> <label class=md-nav__link for=__nav_5> Factory <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Factory data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Factory </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../factory/overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../../factory/deployer_api/ class=md-nav__link> Deployer API </a> </li> <li class=md-nav__item> <a href=../../../factory/registry_api/ class=md-nav__link> Registry API </a> </li> <li class=md-nav__item> <a href=../../../factory/admin_controls/ class=md-nav__link> Admin Controls </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#overview class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=#pool-info-methods class=md-nav__link> Pool Info Methods </a> <nav class=md-nav aria-label="Pool Info Methods"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#stableswapbase_coins class=md-nav__link> StableSwap.base_coins </a> </li> <li class=md-nav__item> <a href=#stableswapcoins class=md-nav__link> StableSwap.coins </a> </li> <li class=md-nav__item> <a href=#stableswapbase_pool class=md-nav__link> StableSwap.base_pool </a> </li> <li class=md-nav__item> <a href=#stableswapbase_virtual_price class=md-nav__link> StableSwap.base_virtual_price </a> </li> <li class=md-nav__item> <a href=#stableswapbase_cache_update class=md-nav__link> StableSwap.base_cache_update() </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#exchange-methods class=md-nav__link> Exchange Methods </a> <nav class=md-nav aria-label="Exchange Methods"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#stableswapexchange class=md-nav__link> StableSwap.exchange </a> </li> <li class=md-nav__item> <a href=#stableswapexchange_underlying class=md-nav__link> StableSwap.exchange_underlying </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/bout3fiddy/curve-mkdocs.git/edit/master/docs/stableswap_exchange/pools/metapools.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>Metapools</h1> <h3 id=overview>Overview<a class=headerlink href=#overview title="Permanent link">&para;</a></h3> <p>A metapool is a pool where a stablecoin is paired against the LP token from another pool, a so-called <em>base</em> pool.</p> <p>For example, a liquidity provider may deposit <code>DAI</code> into <a href=https://etherscan.io/address/0xbebc44782c7db0a1a60cb6fe97d0b483032ff1c7#code>3Pool</a> and in exchange receive the pool’s LP token <code>3CRV</code>. The <code>3CRV</code> LP token may then be deposited into the <a href=https://etherscan.io/address/0x4f062658EaAF2C1ccf8C8e36D6824CDf41167956>GUSD metapool</a>, which contains the coins <code>GUSD</code> and <code>3CRV</code>, in exchange for the metapool’s LP token gusd3CRV. The obtained LP token may then be staked in the metapool’s liquidity gauge for <code>CRV</code> rewards.</p> <p>Metapools provide an opportunity for the base pool liquidity providers to earn additional trading fees by depositing their LP tokens into the metapool. Note that the <code>CRV</code> rewards received for staking LP tokens into the pool’s liquidity gauge may differ for the base pool’s liquidity gauge and the metapool’s liquidity gauge. For details on liquidity gauges and protocol rewards, please refer to Liquidity Gauges and Minting CRV.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Metapools also implement the ABI from plain pools. The template source code for metapools may be viewed on <a href=https://github.com/curvefi/curve-contract/blob/master/contracts/pool-templates/meta/SwapTemplateMeta.vy>GitHub</a>.</p> </div> <h3 id=pool-info-methods>Pool Info Methods<a class=headerlink href=#pool-info-methods title="Permanent link">&para;</a></h3> <h4 id=stableswapbase_coins><code>StableSwap.base_coins</code><a class=headerlink href=#stableswapbase_coins title="Permanent link">&para;</a></h4> <div class="admonition description"> <p class=admonition-title><code>StableSwap.base_coins(i: uint256) → address: view</code></p> <p>Get the coins of the base pool. Returns <code>address</code> of the coin at index <code>i</code>.</p> <table> <thead> <tr> <th>Input</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>i</code></td> <td><code>uint256</code></td> <td>Coin index</td> </tr> </tbody> </table> <details class=quote> <summary>Source code</summary> <div class=highlight><pre><span></span><code><span class=c1># Token corresponding to the pool is always the last one</span>
<span class=hll><span class=n>BASE_POOL_COINS</span><span class=p>:</span> <span class=n>constant</span><span class=p>(</span><span class=n>int128</span><span class=p>)</span> <span class=o>=</span> <span class=mi>3</span>
</span>
<span class=o>...</span>

<span class=hll><span class=n>base_coins</span><span class=p>:</span> <span class=n>public</span><span class=p>(</span><span class=n>address</span><span class=p>[</span><span class=n>BASE_POOL_COINS</span><span class=p>])</span>
</span>
<span class=o>...</span>

<span class=nd>@external</span>
<span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
    <span class=n>_owner</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span>
    <span class=n>_coins</span><span class=p>:</span> <span class=n>address</span><span class=p>[</span><span class=n>N_COINS</span><span class=p>],</span>
    <span class=n>_pool_token</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span>
    <span class=n>_base_pool</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span>
    <span class=n>_A</span><span class=p>:</span> <span class=n>uint256</span><span class=p>,</span>
    <span class=n>_fee</span><span class=p>:</span> <span class=n>uint256</span><span class=p>,</span>
    <span class=n>_admin_fee</span><span class=p>:</span> <span class=n>uint256</span>
<span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    @notice Contract constructor</span>
<span class=sd>    @param _owner Contract owner address</span>
<span class=sd>    @param _coins Addresses of ERC20 conracts of coins</span>
<span class=sd>    @param _pool_token Address of the token representing LP share</span>
<span class=sd>    @param _base_pool Address of the base pool (which will have a virtual price)</span>
<span class=sd>    @param _A Amplification coefficient multiplied by n * (n - 1)</span>
<span class=sd>    @param _fee Fee to charge for exchanges</span>
<span class=sd>    @param _admin_fee Admin fee</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>N_COINS</span><span class=p>):</span>
        <span class=k>assert</span> <span class=n>_coins</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=n>ZERO_ADDRESS</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>coins</span> <span class=o>=</span> <span class=n>_coins</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>initial_A</span> <span class=o>=</span> <span class=n>_A</span> <span class=o>*</span> <span class=n>A_PRECISION</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>future_A</span> <span class=o>=</span> <span class=n>_A</span> <span class=o>*</span> <span class=n>A_PRECISION</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>fee</span> <span class=o>=</span> <span class=n>_fee</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>admin_fee</span> <span class=o>=</span> <span class=n>_admin_fee</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>owner</span> <span class=o>=</span> <span class=n>_owner</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>kill_deadline</span> <span class=o>=</span> <span class=n>block</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>+</span> <span class=n>KILL_DEADLINE_DT</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>token</span> <span class=o>=</span> <span class=n>CurveToken</span><span class=p>(</span><span class=n>_pool_token</span><span class=p>)</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>base_pool</span> <span class=o>=</span> <span class=n>_base_pool</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>base_virtual_price</span> <span class=o>=</span> <span class=n>Curve</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>)</span><span class=o>.</span><span class=n>get_virtual_price</span><span class=p>()</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>base_cache_updated</span> <span class=o>=</span> <span class=n>block</span><span class=o>.</span><span class=n>timestamp</span>
<span class=hll>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>BASE_POOL_COINS</span><span class=p>):</span>
</span><span class=hll>        <span class=n>_base_coin</span><span class=p>:</span> <span class=n>address</span> <span class=o>=</span> <span class=n>Curve</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>)</span><span class=o>.</span><span class=n>coins</span><span class=p>(</span><span class=n>convert</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>uint256</span><span class=p>))</span>
</span><span class=hll>        <span class=bp>self</span><span class=o>.</span><span class=n>base_coins</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>_base_coin</span>
</span><span class=hll>
</span><span class=hll>        <span class=c1># approve underlying coins for infinite transfers</span>
</span><span class=hll>        <span class=n>_response</span><span class=p>:</span> <span class=n>Bytes</span><span class=p>[</span><span class=mi>32</span><span class=p>]</span> <span class=o>=</span> <span class=n>raw_call</span><span class=p>(</span>
</span><span class=hll>            <span class=n>_base_coin</span><span class=p>,</span>
</span><span class=hll>            <span class=n>concat</span><span class=p>(</span>
</span><span class=hll>                <span class=n>method_id</span><span class=p>(</span><span class=s2>&quot;approve(address,uint256)&quot;</span><span class=p>),</span>
</span><span class=hll>                <span class=n>convert</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>,</span> <span class=n>bytes32</span><span class=p>),</span>
</span><span class=hll>                <span class=n>convert</span><span class=p>(</span><span class=n>MAX_UINT256</span><span class=p>,</span> <span class=n>bytes32</span><span class=p>),</span>
</span><span class=hll>            <span class=p>),</span>
</span><span class=hll>            <span class=n>max_outsize</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>
</span><span class=hll>        <span class=p>)</span>
</span><span class=hll>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>_response</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span class=hll>            <span class=k>assert</span> <span class=n>convert</span><span class=p>(</span><span class=n>_response</span><span class=p>,</span> <span class=nb>bool</span><span class=p>)</span>
</span></code></pre></div> </details> <div class="tabbed-set tabbed-alternate" data-tabs=1:1><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>Example</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code>&gt;&gt;&gt; metapool.base_coins<span class=o>(</span><span class=m>0</span><span class=o>)</span>
<span class=s1>&#39;0x6B175474E89094C44Da98b954EedeAC495271d0F&#39;</span>
&gt;&gt;&gt; metapool.base_coins<span class=o>(</span><span class=m>1</span><span class=o>)</span>
<span class=s1>&#39;0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48&#39;</span>
&gt;&gt;&gt; metapool.base_coins<span class=o>(</span><span class=m>2</span><span class=o>)</span>
<span class=s1>&#39;0xdAC17F958D2ee523a2206206994597C13D831ec7&#39;</span>
</code></pre></div> </div> </div> </div> </div> <h4 id=stableswapcoins><code>StableSwap.coins</code><a class=headerlink href=#stableswapcoins title="Permanent link">&para;</a></h4> <div class="admonition description"> <p class=admonition-title><code>StableSwap.coins(i: uint256) → address: view</code></p> <p>Get the coins of the metapool. Returns <code>address</code> of coin at index <code>i</code>.</p> <table> <thead> <tr> <th>Input</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>i</code></td> <td><code>uint256</code></td> <td>Coin index</td> </tr> </tbody> </table> <details class=quote> <summary>Source code</summary> <div class=highlight><pre><span></span><code><span class=hll><span class=n>N_COINS</span><span class=p>:</span> <span class=n>constant</span><span class=p>(</span><span class=n>int128</span><span class=p>)</span> <span class=o>=</span> <span class=mi>2</span>
</span>
<span class=o>...</span>

<span class=hll><span class=n>coins</span><span class=p>:</span> <span class=n>public</span><span class=p>(</span><span class=n>address</span><span class=p>[</span><span class=n>N_COINS</span><span class=p>])</span>
</span>
<span class=o>...</span>

<span class=nd>@external</span>
<span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
    <span class=n>_owner</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span>
<span class=hll>    <span class=n>_coins</span><span class=p>:</span> <span class=n>address</span><span class=p>[</span><span class=n>N_COINS</span><span class=p>],</span>
</span>    <span class=n>_pool_token</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span>
    <span class=n>_base_pool</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span>
    <span class=n>_A</span><span class=p>:</span> <span class=n>uint256</span><span class=p>,</span>
    <span class=n>_fee</span><span class=p>:</span> <span class=n>uint256</span><span class=p>,</span>
    <span class=n>_admin_fee</span><span class=p>:</span> <span class=n>uint256</span>
<span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    @notice Contract constructor</span>
<span class=sd>    @param _owner Contract owner address</span>
<span class=hll><span class=sd>    @param _coins Addresses of ERC20 conracts of coins</span>
</span><span class=sd>    @param _pool_token Address of the token representing LP share</span>
<span class=sd>    @param _base_pool Address of the base pool (which will have a virtual price)</span>
<span class=sd>    @param _A Amplification coefficient multiplied by n * (n - 1)</span>
<span class=sd>    @param _fee Fee to charge for exchanges</span>
<span class=sd>    @param _admin_fee Admin fee</span>
<span class=sd>    &quot;&quot;&quot;</span>
<span class=hll>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>N_COINS</span><span class=p>):</span>
</span><span class=hll>        <span class=k>assert</span> <span class=n>_coins</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=n>ZERO_ADDRESS</span>
</span><span class=hll>    <span class=bp>self</span><span class=o>.</span><span class=n>coins</span> <span class=o>=</span> <span class=n>_coins</span>
</span>    <span class=bp>self</span><span class=o>.</span><span class=n>initial_A</span> <span class=o>=</span> <span class=n>_A</span> <span class=o>*</span> <span class=n>A_PRECISION</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>future_A</span> <span class=o>=</span> <span class=n>_A</span> <span class=o>*</span> <span class=n>A_PRECISION</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>fee</span> <span class=o>=</span> <span class=n>_fee</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>admin_fee</span> <span class=o>=</span> <span class=n>_admin_fee</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>owner</span> <span class=o>=</span> <span class=n>_owner</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>kill_deadline</span> <span class=o>=</span> <span class=n>block</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>+</span> <span class=n>KILL_DEADLINE_DT</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>token</span> <span class=o>=</span> <span class=n>CurveToken</span><span class=p>(</span><span class=n>_pool_token</span><span class=p>)</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>base_pool</span> <span class=o>=</span> <span class=n>_base_pool</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>base_virtual_price</span> <span class=o>=</span> <span class=n>Curve</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>)</span><span class=o>.</span><span class=n>get_virtual_price</span><span class=p>()</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>base_cache_updated</span> <span class=o>=</span> <span class=n>block</span><span class=o>.</span><span class=n>timestamp</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>BASE_POOL_COINS</span><span class=p>):</span>
        <span class=n>_base_coin</span><span class=p>:</span> <span class=n>address</span> <span class=o>=</span> <span class=n>Curve</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>)</span><span class=o>.</span><span class=n>coins</span><span class=p>(</span><span class=n>convert</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>uint256</span><span class=p>))</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>base_coins</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>_base_coin</span>

        <span class=c1># approve underlying coins for infinite transfers</span>
        <span class=n>_response</span><span class=p>:</span> <span class=n>Bytes</span><span class=p>[</span><span class=mi>32</span><span class=p>]</span> <span class=o>=</span> <span class=n>raw_call</span><span class=p>(</span>
            <span class=n>_base_coin</span><span class=p>,</span>
            <span class=n>concat</span><span class=p>(</span>
                <span class=n>method_id</span><span class=p>(</span><span class=s2>&quot;approve(address,uint256)&quot;</span><span class=p>),</span>
                <span class=n>convert</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>,</span> <span class=n>bytes32</span><span class=p>),</span>
                <span class=n>convert</span><span class=p>(</span><span class=n>MAX_UINT256</span><span class=p>,</span> <span class=n>bytes32</span><span class=p>),</span>
            <span class=p>),</span>
            <span class=n>max_outsize</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>_response</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>assert</span> <span class=n>convert</span><span class=p>(</span><span class=n>_response</span><span class=p>,</span> <span class=nb>bool</span><span class=p>)</span>
</code></pre></div> </details> <div class="tabbed-set tabbed-alternate" data-tabs=2:1><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><div class=tabbed-labels><label for=__tabbed_2_1>Example</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code>&gt;&gt;&gt; metapool.coins<span class=o>(</span><span class=m>0</span><span class=o>)</span>
<span class=s1>&#39;0x056Fd409E1d7A124BD7017459dFEa2F387b6d5Cd&#39;</span>
&gt;&gt;&gt; metapool.coins<span class=o>(</span><span class=m>1</span><span class=o>)</span>
<span class=s1>&#39;0x6c3F90f043a72FA612cbac8115EE7e52BDe6E490&#39;</span>
</code></pre></div> <p>In this console example, <code>coins(0)</code> is the metapool’s coin (<code>GUSD</code>) and <code>coins(1)</code> is the LP token of the base pool (<code>3CRV</code>).</p> </div> </div> </div> </div> <h4 id=stableswapbase_pool><code>StableSwap.base_pool</code><a class=headerlink href=#stableswapbase_pool title="Permanent link">&para;</a></h4> <div class="admonition description"> <p class=admonition-title><code>StableSwap.base_pool() → address: view</code></p> <p>Get the address of the base pool. Returns <code>address</code> of the base pool implementation.</p> <details class=quote> <summary>Source code</summary> <div class=highlight><pre><span></span><code><span class=hll><span class=n>base_pool</span><span class=p>:</span> <span class=n>public</span><span class=p>(</span><span class=n>address</span><span class=p>)</span>
</span>
<span class=o>...</span>

<span class=nd>@external</span>
<span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
    <span class=n>_owner</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span>
    <span class=n>_coins</span><span class=p>:</span> <span class=n>address</span><span class=p>[</span><span class=n>N_COINS</span><span class=p>],</span>
    <span class=n>_pool_token</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span>
<span class=hll>    <span class=n>_base_pool</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span>
</span>    <span class=n>_A</span><span class=p>:</span> <span class=n>uint256</span><span class=p>,</span>
    <span class=n>_fee</span><span class=p>:</span> <span class=n>uint256</span><span class=p>,</span>
    <span class=n>_admin_fee</span><span class=p>:</span> <span class=n>uint256</span>
<span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    @notice Contract constructor</span>
<span class=sd>    @param _owner Contract owner address</span>
<span class=sd>    @param _coins Addresses of ERC20 conracts of coins</span>
<span class=sd>    @param _pool_token Address of the token representing LP share</span>
<span class=hll><span class=sd>    @param _base_pool Address of the base pool (which will have a virtual price)</span>
</span><span class=sd>    @param _A Amplification coefficient multiplied by n * (n - 1)</span>
<span class=sd>    @param _fee Fee to charge for exchanges</span>
<span class=sd>    @param _admin_fee Admin fee</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>N_COINS</span><span class=p>):</span>
        <span class=k>assert</span> <span class=n>_coins</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=n>ZERO_ADDRESS</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>coins</span> <span class=o>=</span> <span class=n>_coins</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>initial_A</span> <span class=o>=</span> <span class=n>_A</span> <span class=o>*</span> <span class=n>A_PRECISION</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>future_A</span> <span class=o>=</span> <span class=n>_A</span> <span class=o>*</span> <span class=n>A_PRECISION</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>fee</span> <span class=o>=</span> <span class=n>_fee</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>admin_fee</span> <span class=o>=</span> <span class=n>_admin_fee</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>owner</span> <span class=o>=</span> <span class=n>_owner</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>kill_deadline</span> <span class=o>=</span> <span class=n>block</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>+</span> <span class=n>KILL_DEADLINE_DT</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>token</span> <span class=o>=</span> <span class=n>CurveToken</span><span class=p>(</span><span class=n>_pool_token</span><span class=p>)</span>

<span class=hll>    <span class=bp>self</span><span class=o>.</span><span class=n>base_pool</span> <span class=o>=</span> <span class=n>_base_pool</span>
</span>    <span class=bp>self</span><span class=o>.</span><span class=n>base_virtual_price</span> <span class=o>=</span> <span class=n>Curve</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>)</span><span class=o>.</span><span class=n>get_virtual_price</span><span class=p>()</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>base_cache_updated</span> <span class=o>=</span> <span class=n>block</span><span class=o>.</span><span class=n>timestamp</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>BASE_POOL_COINS</span><span class=p>):</span>
<span class=hll>        <span class=n>_base_coin</span><span class=p>:</span> <span class=n>address</span> <span class=o>=</span> <span class=n>Curve</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>)</span><span class=o>.</span><span class=n>coins</span><span class=p>(</span><span class=n>convert</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>uint256</span><span class=p>))</span>
</span>        <span class=bp>self</span><span class=o>.</span><span class=n>base_coins</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>_base_coin</span>

        <span class=c1># approve underlying coins for infinite transfers</span>
        <span class=n>_response</span><span class=p>:</span> <span class=n>Bytes</span><span class=p>[</span><span class=mi>32</span><span class=p>]</span> <span class=o>=</span> <span class=n>raw_call</span><span class=p>(</span>
            <span class=n>_base_coin</span><span class=p>,</span>
            <span class=n>concat</span><span class=p>(</span>
                <span class=n>method_id</span><span class=p>(</span><span class=s2>&quot;approve(address,uint256)&quot;</span><span class=p>),</span>
                <span class=n>convert</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>,</span> <span class=n>bytes32</span><span class=p>),</span>
                <span class=n>convert</span><span class=p>(</span><span class=n>MAX_UINT256</span><span class=p>,</span> <span class=n>bytes32</span><span class=p>),</span>
            <span class=p>),</span>
            <span class=n>max_outsize</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>_response</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>assert</span> <span class=n>convert</span><span class=p>(</span><span class=n>_response</span><span class=p>,</span> <span class=nb>bool</span><span class=p>)</span>
</code></pre></div> </details> <div class="tabbed-set tabbed-alternate" data-tabs=3:1><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><div class=tabbed-labels><label for=__tabbed_3_1>Example</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code>&gt;&gt;&gt; metapool.base_pool<span class=o>()</span>
<span class=s1>&#39;0xbEbc44782C7dB0a1A60Cb6fe97d0b483032FF1C7&#39;</span>
</code></pre></div> </div> </div> </div> </div> <h4 id=stableswapbase_virtual_price><code>StableSwap.base_virtual_price</code><a class=headerlink href=#stableswapbase_virtual_price title="Permanent link">&para;</a></h4> <div class="admonition description"> <p class=admonition-title><code>StableSwap.base_virtual_price() → uint256: view</code></p> <p>Get the current price of the base pool LP token relative to the underlying base pool assets.</p> <details class=quote> <summary>Source code</summary> <div class=highlight><pre><span></span><code><span class=hll><span class=n>base_virtual_price</span><span class=p>:</span> <span class=n>public</span><span class=p>(</span><span class=n>uint256</span><span class=p>)</span>
</span>
<span class=o>...</span>

<span class=nd>@external</span>
<span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
    <span class=n>_owner</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span>
    <span class=n>_coins</span><span class=p>:</span> <span class=n>address</span><span class=p>[</span><span class=n>N_COINS</span><span class=p>],</span>
    <span class=n>_pool_token</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span>
    <span class=n>_base_pool</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span>
    <span class=n>_A</span><span class=p>:</span> <span class=n>uint256</span><span class=p>,</span>
    <span class=n>_fee</span><span class=p>:</span> <span class=n>uint256</span><span class=p>,</span>
    <span class=n>_admin_fee</span><span class=p>:</span> <span class=n>uint256</span>
<span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    @notice Contract constructor</span>
<span class=sd>    @param _owner Contract owner address</span>
<span class=sd>    @param _coins Addresses of ERC20 conracts of coins</span>
<span class=sd>    @param _pool_token Address of the token representing LP share</span>
<span class=sd>    @param _base_pool Address of the base pool (which will have a virtual price)</span>
<span class=sd>    @param _A Amplification coefficient multiplied by n * (n - 1)</span>
<span class=sd>    @param _fee Fee to charge for exchanges</span>
<span class=sd>    @param _admin_fee Admin fee</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>N_COINS</span><span class=p>):</span>
        <span class=k>assert</span> <span class=n>_coins</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=n>ZERO_ADDRESS</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>coins</span> <span class=o>=</span> <span class=n>_coins</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>initial_A</span> <span class=o>=</span> <span class=n>_A</span> <span class=o>*</span> <span class=n>A_PRECISION</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>future_A</span> <span class=o>=</span> <span class=n>_A</span> <span class=o>*</span> <span class=n>A_PRECISION</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>fee</span> <span class=o>=</span> <span class=n>_fee</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>admin_fee</span> <span class=o>=</span> <span class=n>_admin_fee</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>owner</span> <span class=o>=</span> <span class=n>_owner</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>kill_deadline</span> <span class=o>=</span> <span class=n>block</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>+</span> <span class=n>KILL_DEADLINE_DT</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>token</span> <span class=o>=</span> <span class=n>CurveToken</span><span class=p>(</span><span class=n>_pool_token</span><span class=p>)</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>base_pool</span> <span class=o>=</span> <span class=n>_base_pool</span>
<span class=hll>    <span class=bp>self</span><span class=o>.</span><span class=n>base_virtual_price</span> <span class=o>=</span> <span class=n>Curve</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>)</span><span class=o>.</span><span class=n>get_virtual_price</span><span class=p>()</span>
</span>    <span class=bp>self</span><span class=o>.</span><span class=n>base_cache_updated</span> <span class=o>=</span> <span class=n>block</span><span class=o>.</span><span class=n>timestamp</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>BASE_POOL_COINS</span><span class=p>):</span>
        <span class=n>_base_coin</span><span class=p>:</span> <span class=n>address</span> <span class=o>=</span> <span class=n>Curve</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>)</span><span class=o>.</span><span class=n>coins</span><span class=p>(</span><span class=n>convert</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>uint256</span><span class=p>))</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>base_coins</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>_base_coin</span>

        <span class=c1># approve underlying coins for infinite transfers</span>
        <span class=n>_response</span><span class=p>:</span> <span class=n>Bytes</span><span class=p>[</span><span class=mi>32</span><span class=p>]</span> <span class=o>=</span> <span class=n>raw_call</span><span class=p>(</span>
            <span class=n>_base_coin</span><span class=p>,</span>
            <span class=n>concat</span><span class=p>(</span>
                <span class=n>method_id</span><span class=p>(</span><span class=s2>&quot;approve(address,uint256)&quot;</span><span class=p>),</span>
                <span class=n>convert</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>,</span> <span class=n>bytes32</span><span class=p>),</span>
                <span class=n>convert</span><span class=p>(</span><span class=n>MAX_UINT256</span><span class=p>,</span> <span class=n>bytes32</span><span class=p>),</span>
            <span class=p>),</span>
            <span class=n>max_outsize</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>_response</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>assert</span> <span class=n>convert</span><span class=p>(</span><span class=n>_response</span><span class=p>,</span> <span class=nb>bool</span><span class=p>)</span>
</code></pre></div> </details> <div class="tabbed-set tabbed-alternate" data-tabs=4:1><input checked=checked id=__tabbed_4_1 name=__tabbed_4 type=radio><div class=tabbed-labels><label for=__tabbed_4_1>Example</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code>&gt;&gt;&gt; metapool.base_virtual_price<span class=o>()</span>
<span class=m>1014750545929625438</span>
</code></pre></div> </div> </div> </div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The base pool’s virtual price is only fetched from the base pool if the cached price has expired. A fetched based pool virtual price is cached for 10 minutes (<code>BASE_CACHE_EXPIRES: constant(int128) = 10 * 60</code>).</p> </div> </div> <h4 id=stableswapbase_cache_update><code>StableSwap.base_cache_update()</code><a class=headerlink href=#stableswapbase_cache_update title="Permanent link">&para;</a></h4> <div class="admonition description"> <p class=admonition-title><code>StableSwap.base_cache_update() → uint256: view</code></p> <p>Get the timestamp at which the base pool virtual price was last cached.</p> <details class=quote> <summary>Source code</summary> <div class=highlight><pre><span></span><code><span class=hll><span class=n>base_cache_updated</span><span class=p>:</span> <span class=n>public</span><span class=p>(</span><span class=n>uint256</span><span class=p>)</span>
</span>
<span class=o>...</span>

<span class=hll><span class=n>BASE_CACHE_EXPIRES</span><span class=p>:</span> <span class=n>constant</span><span class=p>(</span><span class=n>int128</span><span class=p>)</span> <span class=o>=</span> <span class=mi>10</span> <span class=o>*</span> <span class=mi>60</span>  <span class=c1># 10 min</span>
</span>
<span class=o>...</span>

<span class=nd>@external</span>
<span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
    <span class=n>_owner</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span>
    <span class=n>_coins</span><span class=p>:</span> <span class=n>address</span><span class=p>[</span><span class=n>N_COINS</span><span class=p>],</span>
    <span class=n>_pool_token</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span>
    <span class=n>_base_pool</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span>
    <span class=n>_A</span><span class=p>:</span> <span class=n>uint256</span><span class=p>,</span>
    <span class=n>_fee</span><span class=p>:</span> <span class=n>uint256</span><span class=p>,</span>
    <span class=n>_admin_fee</span><span class=p>:</span> <span class=n>uint256</span>
<span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    @notice Contract constructor</span>
<span class=sd>    @param _owner Contract owner address</span>
<span class=sd>    @param _coins Addresses of ERC20 conracts of coins</span>
<span class=sd>    @param _pool_token Address of the token representing LP share</span>
<span class=sd>    @param _base_pool Address of the base pool (which will have a virtual price)</span>
<span class=sd>    @param _A Amplification coefficient multiplied by n * (n - 1)</span>
<span class=sd>    @param _fee Fee to charge for exchanges</span>
<span class=sd>    @param _admin_fee Admin fee</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>N_COINS</span><span class=p>):</span>
        <span class=k>assert</span> <span class=n>_coins</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=n>ZERO_ADDRESS</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>coins</span> <span class=o>=</span> <span class=n>_coins</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>initial_A</span> <span class=o>=</span> <span class=n>_A</span> <span class=o>*</span> <span class=n>A_PRECISION</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>future_A</span> <span class=o>=</span> <span class=n>_A</span> <span class=o>*</span> <span class=n>A_PRECISION</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>fee</span> <span class=o>=</span> <span class=n>_fee</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>admin_fee</span> <span class=o>=</span> <span class=n>_admin_fee</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>owner</span> <span class=o>=</span> <span class=n>_owner</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>kill_deadline</span> <span class=o>=</span> <span class=n>block</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>+</span> <span class=n>KILL_DEADLINE_DT</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>token</span> <span class=o>=</span> <span class=n>CurveToken</span><span class=p>(</span><span class=n>_pool_token</span><span class=p>)</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>base_pool</span> <span class=o>=</span> <span class=n>_base_pool</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>base_virtual_price</span> <span class=o>=</span> <span class=n>Curve</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>)</span><span class=o>.</span><span class=n>get_virtual_price</span><span class=p>()</span>
<span class=hll>    <span class=bp>self</span><span class=o>.</span><span class=n>base_cache_updated</span> <span class=o>=</span> <span class=n>block</span><span class=o>.</span><span class=n>timestamp</span>
</span>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>BASE_POOL_COINS</span><span class=p>):</span>
        <span class=n>_base_coin</span><span class=p>:</span> <span class=n>address</span> <span class=o>=</span> <span class=n>Curve</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>)</span><span class=o>.</span><span class=n>coins</span><span class=p>(</span><span class=n>convert</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>uint256</span><span class=p>))</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>base_coins</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>_base_coin</span>

        <span class=c1># approve underlying coins for infinite transfers</span>
        <span class=n>_response</span><span class=p>:</span> <span class=n>Bytes</span><span class=p>[</span><span class=mi>32</span><span class=p>]</span> <span class=o>=</span> <span class=n>raw_call</span><span class=p>(</span>
            <span class=n>_base_coin</span><span class=p>,</span>
            <span class=n>concat</span><span class=p>(</span>
                <span class=n>method_id</span><span class=p>(</span><span class=s2>&quot;approve(address,uint256)&quot;</span><span class=p>),</span>
                <span class=n>convert</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>,</span> <span class=n>bytes32</span><span class=p>),</span>
                <span class=n>convert</span><span class=p>(</span><span class=n>MAX_UINT256</span><span class=p>,</span> <span class=n>bytes32</span><span class=p>),</span>
            <span class=p>),</span>
            <span class=n>max_outsize</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>_response</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>assert</span> <span class=n>convert</span><span class=p>(</span><span class=n>_response</span><span class=p>,</span> <span class=nb>bool</span><span class=p>)</span>

<span class=o>...</span>

<span class=nd>@internal</span>
<span class=k>def</span> <span class=nf>_vp_rate</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=n>uint256</span><span class=p>:</span>
<span class=hll>    <span class=k>if</span> <span class=n>block</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>base_cache_updated</span> <span class=o>+</span> <span class=n>BASE_CACHE_EXPIRES</span><span class=p>:</span>
</span>        <span class=n>vprice</span><span class=p>:</span> <span class=n>uint256</span> <span class=o>=</span> <span class=n>Curve</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base_pool</span><span class=p>)</span><span class=o>.</span><span class=n>get_virtual_price</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>base_virtual_price</span> <span class=o>=</span> <span class=n>vprice</span>
<span class=hll>        <span class=bp>self</span><span class=o>.</span><span class=n>base_cache_updated</span> <span class=o>=</span> <span class=n>block</span><span class=o>.</span><span class=n>timestamp</span>
</span>        <span class=k>return</span> <span class=n>vprice</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>base_virtual_price</span>

<span class=nd>@internal</span>
<span class=nd>@view</span>
<span class=k>def</span> <span class=nf>_vp_rate_ro</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=n>uint256</span><span class=p>:</span>
<span class=hll>    <span class=k>if</span> <span class=n>block</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>base_cache_updated</span> <span class=o>+</span> <span class=n>BASE_CACHE_EXPIRES</span><span class=p>:</span>
</span>        <span class=k>return</span> <span class=n>Curve</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base_pool</span><span class=p>)</span><span class=o>.</span><span class=n>get_virtual_price</span><span class=p>()</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>base_virtual_price</span>
</code></pre></div> </details> <div class="tabbed-set tabbed-alternate" data-tabs=5:1><input checked=checked id=__tabbed_5_1 name=__tabbed_5 type=radio><div class=tabbed-labels><label for=__tabbed_5_1>Example</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code>&gt;&gt;&gt; metapool.base_cache_updated<span class=o>()</span>
<span class=m>1616583340</span>
</code></pre></div> </div> </div> </div> </div> <h3 id=exchange-methods>Exchange Methods<a class=headerlink href=#exchange-methods title="Permanent link">&para;</a></h3> <p>Similar to lending pools, on metapools exchanges can be made either between the coins the metapool actually holds (another pool’s LP token and some other coin) or between the metapool’s underlying coins. In the context of a metapool, <strong>underlying</strong> coins refers to the metapool’s coin and any of the base pool’s coins. The base pool’s LP token is <strong>not</strong> included as an underlying coin.</p> <p>For example, the GUSD metapool would have the following:</p> <p>Coins: <code>GUSD</code>, <code>3CRV</code> (3Pool LP)</p> <p>Underlying coins: <code>GUSD</code>, <code>DAI</code>, <code>USDC</code>, <code>USDT</code></p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>While metapools contain public getters for <code>coins</code> and <code>base_coins</code>, there exists no getter for obtaining a list of all underlying coins.</p> </div> <h4 id=stableswapexchange><code>StableSwap.exchange</code><a class=headerlink href=#stableswapexchange title="Permanent link">&para;</a></h4> <div class="admonition description"> <p class=admonition-title><code>StableSwap.exchange(i: int128, j: int128, _dx: uint256, _min_dy: uint256) → uint256</code></p> <p>Perform an exchange between two (non-underlying) coins in the metapool. Index values can be found via the <code>coins</code> public getter method.</p> <p>Returns: the actual amount of coin <code>j</code> received.</p> <table> <thead> <tr> <th>Input</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>i</code></td> <td><code>int128</code></td> <td>Index value for the coin to send</td> </tr> <tr> <td><code>j</code></td> <td><code>int128</code></td> <td>Index value of the coin to receive</td> </tr> <tr> <td><code>_dx</code></td> <td><code>uint256</code></td> <td>Amount of <code>i</code> being exchanged</td> </tr> <tr> <td><code>_min_dy</code></td> <td><code>uint256</code></td> <td>Minimum amount of <code>j</code> to receive</td> </tr> </tbody> </table> <p>Emits: <mark style="background-color: #FFD580; color: black">TokenExchange</mark></p> <p>todo: explain how fee is calculated</p> <details class=quote> <summary>Source code</summary> <div class=highlight><pre><span></span><code><span class=nd>@external</span>
<span class=nd>@nonreentrant</span><span class=p>(</span><span class=s1>&#39;lock&#39;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>exchange</span><span class=p>(</span><span class=n>i</span><span class=p>:</span> <span class=n>int128</span><span class=p>,</span> <span class=n>j</span><span class=p>:</span> <span class=n>int128</span><span class=p>,</span> <span class=n>dx</span><span class=p>:</span> <span class=n>uint256</span><span class=p>,</span> <span class=n>min_dy</span><span class=p>:</span> <span class=n>uint256</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>uint256</span><span class=p>:</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    @notice Perform an exchange between two coins</span>
<span class=sd>    @dev Index values can be found via the `coins` public getter method</span>
<span class=sd>    @param i Index value for the coin to send</span>
<span class=sd>    @param j Index valie of the coin to recieve</span>
<span class=sd>    @param dx Amount of `i` being exchanged</span>
<span class=sd>    @param min_dy Minimum amount of `j` to receive</span>
<span class=sd>    @return Actual amount of `j` received</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=k>assert</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_killed</span>  <span class=c1># dev: is killed</span>
    <span class=n>rates</span><span class=p>:</span> <span class=n>uint256</span><span class=p>[</span><span class=n>N_COINS</span><span class=p>]</span> <span class=o>=</span> <span class=n>RATES</span>
    <span class=n>rates</span><span class=p>[</span><span class=n>MAX_COIN</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_vp_rate</span><span class=p>()</span>

    <span class=n>old_balances</span><span class=p>:</span> <span class=n>uint256</span><span class=p>[</span><span class=n>N_COINS</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>balances</span>
    <span class=n>xp</span><span class=p>:</span> <span class=n>uint256</span><span class=p>[</span><span class=n>N_COINS</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_xp_mem</span><span class=p>(</span><span class=n>rates</span><span class=p>[</span><span class=n>MAX_COIN</span><span class=p>],</span> <span class=n>old_balances</span><span class=p>)</span>

    <span class=n>x</span><span class=p>:</span> <span class=n>uint256</span> <span class=o>=</span> <span class=n>xp</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+</span> <span class=n>dx</span> <span class=o>*</span> <span class=n>rates</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>/</span> <span class=n>PRECISION</span>
    <span class=n>y</span><span class=p>:</span> <span class=n>uint256</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_y</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>xp</span><span class=p>)</span>

    <span class=n>dy</span><span class=p>:</span> <span class=n>uint256</span> <span class=o>=</span> <span class=n>xp</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>-</span> <span class=n>y</span> <span class=o>-</span> <span class=mi>1</span>  <span class=c1># -1 just in case there were some rounding errors</span>
    <span class=n>dy_fee</span><span class=p>:</span> <span class=n>uint256</span> <span class=o>=</span> <span class=n>dy</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>fee</span> <span class=o>/</span> <span class=n>FEE_DENOMINATOR</span>

    <span class=c1># Convert all to real units</span>
    <span class=n>dy</span> <span class=o>=</span> <span class=p>(</span><span class=n>dy</span> <span class=o>-</span> <span class=n>dy_fee</span><span class=p>)</span> <span class=o>*</span> <span class=n>PRECISION</span> <span class=o>/</span> <span class=n>rates</span><span class=p>[</span><span class=n>j</span><span class=p>]</span>
    <span class=k>assert</span> <span class=n>dy</span> <span class=o>&gt;=</span> <span class=n>min_dy</span><span class=p>,</span> <span class=s2>&quot;Too few coins in result&quot;</span>

    <span class=n>dy_admin_fee</span><span class=p>:</span> <span class=n>uint256</span> <span class=o>=</span> <span class=n>dy_fee</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>admin_fee</span> <span class=o>/</span> <span class=n>FEE_DENOMINATOR</span>
    <span class=n>dy_admin_fee</span> <span class=o>=</span> <span class=n>dy_admin_fee</span> <span class=o>*</span> <span class=n>PRECISION</span> <span class=o>/</span> <span class=n>rates</span><span class=p>[</span><span class=n>j</span><span class=p>]</span>

    <span class=c1># Change balances exactly in same way as we change actual ERC20 coin amounts</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>balances</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>old_balances</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+</span> <span class=n>dx</span>
    <span class=c1># When rounding errors happen, we undercharge admin fee in favor of LP</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>balances</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>old_balances</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>-</span> <span class=n>dy</span> <span class=o>-</span> <span class=n>dy_admin_fee</span>

    <span class=k>assert</span> <span class=n>ERC20</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>coins</span><span class=p>[</span><span class=n>i</span><span class=p>])</span><span class=o>.</span><span class=n>transferFrom</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>sender</span><span class=p>,</span> <span class=bp>self</span><span class=p>,</span> <span class=n>dx</span><span class=p>)</span>
    <span class=k>assert</span> <span class=n>ERC20</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>coins</span><span class=p>[</span><span class=n>j</span><span class=p>])</span><span class=o>.</span><span class=n>transfer</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>sender</span><span class=p>,</span> <span class=n>dy</span><span class=p>)</span>

    <span class=n>log</span> <span class=n>TokenExchange</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>sender</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>dx</span><span class=p>,</span> <span class=n>j</span><span class=p>,</span> <span class=n>dy</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>dy</span>
</code></pre></div> </details> <div class="tabbed-set tabbed-alternate" data-tabs=6:1><input checked=checked id=__tabbed_6_1 name=__tabbed_6 type=radio><div class=tabbed-labels><label for=__tabbed_6_1>Example</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code>&gt;&gt;&gt; lending_pool.exchange<span class=o>()</span>
todo: console output
</code></pre></div> </div> </div> </div> </div> <h4 id=stableswapexchange_underlying><code>StableSwap.exchange_underlying</code><a class=headerlink href=#stableswapexchange_underlying title="Permanent link">&para;</a></h4> <div class="admonition description"> <p class=admonition-title>StableSwap.exchange_underlying(i: int128, j: int128, _dx: uint256, _min_dy: uint256) → uint256</p> <p>Perform an exchange between two underlying tokens. Index values are the <code>coins</code> followed by the <code>base_coins</code>, where the base pool LP token is <strong>not</strong> included as a value. </p> <p>Returns: the actual amount of coin <code>j</code> received.</p> <table> <thead> <tr> <th>Input</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>i</code></td> <td><code>int128</code></td> <td>Index value for the coin to send</td> </tr> <tr> <td><code>j</code></td> <td><code>int128</code></td> <td>Index value of the coin to receive</td> </tr> <tr> <td><code>_dx</code></td> <td><code>uint256</code></td> <td>Amount of <code>i</code> being exchanged</td> </tr> <tr> <td><code>_min_dy</code></td> <td><code>uint256</code></td> <td>Minimum amount of <code>j</code> to receive</td> </tr> </tbody> </table> <p>Emits: <mark style="background-color: #FFD580; color: black">TokenExchangeUnderlying</mark></p> <details class=quote> <summary>Source code</summary> <div class=highlight><pre><span></span><code><span class=nd>@external</span>
<span class=nd>@nonreentrant</span><span class=p>(</span><span class=s1>&#39;lock&#39;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>exchange_underlying</span><span class=p>(</span><span class=n>i</span><span class=p>:</span> <span class=n>int128</span><span class=p>,</span> <span class=n>j</span><span class=p>:</span> <span class=n>int128</span><span class=p>,</span> <span class=n>dx</span><span class=p>:</span> <span class=n>uint256</span><span class=p>,</span> <span class=n>min_dy</span><span class=p>:</span> <span class=n>uint256</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>uint256</span><span class=p>:</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    @notice Perform an exchange between two underlying coins</span>
<span class=sd>    @dev Index values can be found via the `underlying_coins` public getter method</span>
<span class=sd>    @param i Index value for the underlying coin to send</span>
<span class=sd>    @param j Index valie of the underlying coin to recieve</span>
<span class=sd>    @param dx Amount of `i` being exchanged</span>
<span class=sd>    @param min_dy Minimum amount of `j` to receive</span>
<span class=sd>    @return Actual amount of `j` received</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=k>assert</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_killed</span>  <span class=c1># dev: is killed</span>
    <span class=n>rates</span><span class=p>:</span> <span class=n>uint256</span><span class=p>[</span><span class=n>N_COINS</span><span class=p>]</span> <span class=o>=</span> <span class=n>RATES</span>
    <span class=n>rates</span><span class=p>[</span><span class=n>MAX_COIN</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_vp_rate</span><span class=p>()</span>
    <span class=n>_base_pool</span><span class=p>:</span> <span class=n>address</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>base_pool</span>

    <span class=c1># Use base_i or base_j if they are &gt;= 0</span>
    <span class=n>base_i</span><span class=p>:</span> <span class=n>int128</span> <span class=o>=</span> <span class=n>i</span> <span class=o>-</span> <span class=n>MAX_COIN</span>
    <span class=n>base_j</span><span class=p>:</span> <span class=n>int128</span> <span class=o>=</span> <span class=n>j</span> <span class=o>-</span> <span class=n>MAX_COIN</span>
    <span class=n>meta_i</span><span class=p>:</span> <span class=n>int128</span> <span class=o>=</span> <span class=n>MAX_COIN</span>
    <span class=n>meta_j</span><span class=p>:</span> <span class=n>int128</span> <span class=o>=</span> <span class=n>MAX_COIN</span>
    <span class=k>if</span> <span class=n>base_i</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>meta_i</span> <span class=o>=</span> <span class=n>i</span>
    <span class=k>if</span> <span class=n>base_j</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>meta_j</span> <span class=o>=</span> <span class=n>j</span>
    <span class=n>dy</span><span class=p>:</span> <span class=n>uint256</span> <span class=o>=</span> <span class=mi>0</span>

    <span class=c1># Addresses for input and output coins</span>
    <span class=n>input_coin</span><span class=p>:</span> <span class=n>address</span> <span class=o>=</span> <span class=n>ZERO_ADDRESS</span>
    <span class=k>if</span> <span class=n>base_i</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>input_coin</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>coins</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>input_coin</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>base_coins</span><span class=p>[</span><span class=n>base_i</span><span class=p>]</span>
    <span class=n>output_coin</span><span class=p>:</span> <span class=n>address</span> <span class=o>=</span> <span class=n>ZERO_ADDRESS</span>
    <span class=k>if</span> <span class=n>base_j</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>output_coin</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>coins</span><span class=p>[</span><span class=n>j</span><span class=p>]</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>output_coin</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>base_coins</span><span class=p>[</span><span class=n>base_j</span><span class=p>]</span>

    <span class=c1># Handle potential Tether fees</span>
    <span class=n>dx_w_fee</span><span class=p>:</span> <span class=n>uint256</span> <span class=o>=</span> <span class=n>dx</span>
    <span class=k>if</span> <span class=n>input_coin</span> <span class=o>==</span> <span class=n>FEE_ASSET</span><span class=p>:</span>
        <span class=n>dx_w_fee</span> <span class=o>=</span> <span class=n>ERC20</span><span class=p>(</span><span class=n>FEE_ASSET</span><span class=p>)</span><span class=o>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
    <span class=c1># &quot;safeTransferFrom&quot; which works for ERC20s which return bool or not</span>
    <span class=n>_response</span><span class=p>:</span> <span class=n>Bytes</span><span class=p>[</span><span class=mi>32</span><span class=p>]</span> <span class=o>=</span> <span class=n>raw_call</span><span class=p>(</span>
        <span class=n>input_coin</span><span class=p>,</span>
        <span class=n>concat</span><span class=p>(</span>
            <span class=n>method_id</span><span class=p>(</span><span class=s2>&quot;transferFrom(address,address,uint256)&quot;</span><span class=p>),</span>
            <span class=n>convert</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>sender</span><span class=p>,</span> <span class=n>bytes32</span><span class=p>),</span>
            <span class=n>convert</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>bytes32</span><span class=p>),</span>
            <span class=n>convert</span><span class=p>(</span><span class=n>dx</span><span class=p>,</span> <span class=n>bytes32</span><span class=p>),</span>
        <span class=p>),</span>
        <span class=n>max_outsize</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>
    <span class=p>)</span>  <span class=c1># dev: failed transfer</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>_response</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
        <span class=k>assert</span> <span class=n>convert</span><span class=p>(</span><span class=n>_response</span><span class=p>,</span> <span class=nb>bool</span><span class=p>)</span>  <span class=c1># dev: failed transfer</span>
    <span class=c1># end &quot;safeTransferFrom&quot;</span>
    <span class=c1># Handle potential Tether fees</span>
    <span class=k>if</span> <span class=n>input_coin</span> <span class=o>==</span> <span class=n>FEE_ASSET</span><span class=p>:</span>
        <span class=n>dx_w_fee</span> <span class=o>=</span> <span class=n>ERC20</span><span class=p>(</span><span class=n>FEE_ASSET</span><span class=p>)</span><span class=o>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-</span> <span class=n>dx_w_fee</span>

    <span class=k>if</span> <span class=n>base_i</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>base_j</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>old_balances</span><span class=p>:</span> <span class=n>uint256</span><span class=p>[</span><span class=n>N_COINS</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>balances</span>
        <span class=n>xp</span><span class=p>:</span> <span class=n>uint256</span><span class=p>[</span><span class=n>N_COINS</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_xp_mem</span><span class=p>(</span><span class=n>rates</span><span class=p>[</span><span class=n>MAX_COIN</span><span class=p>],</span> <span class=n>old_balances</span><span class=p>)</span>

        <span class=n>x</span><span class=p>:</span> <span class=n>uint256</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=k>if</span> <span class=n>base_i</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=n>x</span> <span class=o>=</span> <span class=n>xp</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+</span> <span class=n>dx_w_fee</span> <span class=o>*</span> <span class=n>rates</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>/</span> <span class=n>PRECISION</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=c1># i is from BasePool</span>
            <span class=c1># At first, get the amount of pool tokens</span>
            <span class=n>base_inputs</span><span class=p>:</span> <span class=n>uint256</span><span class=p>[</span><span class=n>BASE_N_COINS</span><span class=p>]</span> <span class=o>=</span> <span class=n>empty</span><span class=p>(</span><span class=n>uint256</span><span class=p>[</span><span class=n>BASE_N_COINS</span><span class=p>])</span>
            <span class=n>base_inputs</span><span class=p>[</span><span class=n>base_i</span><span class=p>]</span> <span class=o>=</span> <span class=n>dx_w_fee</span>
            <span class=n>coin_i</span><span class=p>:</span> <span class=n>address</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>coins</span><span class=p>[</span><span class=n>MAX_COIN</span><span class=p>]</span>
            <span class=c1># Deposit and measure delta</span>
            <span class=n>x</span> <span class=o>=</span> <span class=n>ERC20</span><span class=p>(</span><span class=n>coin_i</span><span class=p>)</span><span class=o>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
            <span class=n>Curve</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>)</span><span class=o>.</span><span class=n>add_liquidity</span><span class=p>(</span><span class=n>base_inputs</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
            <span class=c1># Need to convert pool token to &quot;virtual&quot; units using rates</span>
            <span class=c1># dx is also different now</span>
            <span class=n>dx_w_fee</span> <span class=o>=</span> <span class=n>ERC20</span><span class=p>(</span><span class=n>coin_i</span><span class=p>)</span><span class=o>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-</span> <span class=n>x</span>
            <span class=n>x</span> <span class=o>=</span> <span class=n>dx_w_fee</span> <span class=o>*</span> <span class=n>rates</span><span class=p>[</span><span class=n>MAX_COIN</span><span class=p>]</span> <span class=o>/</span> <span class=n>PRECISION</span>
            <span class=c1># Adding number of pool tokens</span>
            <span class=n>x</span> <span class=o>+=</span> <span class=n>xp</span><span class=p>[</span><span class=n>MAX_COIN</span><span class=p>]</span>

        <span class=n>y</span><span class=p>:</span> <span class=n>uint256</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_y</span><span class=p>(</span><span class=n>meta_i</span><span class=p>,</span> <span class=n>meta_j</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>xp</span><span class=p>)</span>

        <span class=c1># Either a real coin or token</span>
        <span class=n>dy</span> <span class=o>=</span> <span class=n>xp</span><span class=p>[</span><span class=n>meta_j</span><span class=p>]</span> <span class=o>-</span> <span class=n>y</span> <span class=o>-</span> <span class=mi>1</span>  <span class=c1># -1 just in case there were some rounding errors</span>
        <span class=n>dy_fee</span><span class=p>:</span> <span class=n>uint256</span> <span class=o>=</span> <span class=n>dy</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>fee</span> <span class=o>/</span> <span class=n>FEE_DENOMINATOR</span>

        <span class=c1># Convert all to real units</span>
        <span class=c1># Works for both pool coins and real coins</span>
        <span class=n>dy</span> <span class=o>=</span> <span class=p>(</span><span class=n>dy</span> <span class=o>-</span> <span class=n>dy_fee</span><span class=p>)</span> <span class=o>*</span> <span class=n>PRECISION</span> <span class=o>/</span> <span class=n>rates</span><span class=p>[</span><span class=n>meta_j</span><span class=p>]</span>

        <span class=n>dy_admin_fee</span><span class=p>:</span> <span class=n>uint256</span> <span class=o>=</span> <span class=n>dy_fee</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>admin_fee</span> <span class=o>/</span> <span class=n>FEE_DENOMINATOR</span>
        <span class=n>dy_admin_fee</span> <span class=o>=</span> <span class=n>dy_admin_fee</span> <span class=o>*</span> <span class=n>PRECISION</span> <span class=o>/</span> <span class=n>rates</span><span class=p>[</span><span class=n>meta_j</span><span class=p>]</span>

        <span class=c1># Change balances exactly in same way as we change actual ERC20 coin amounts</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>balances</span><span class=p>[</span><span class=n>meta_i</span><span class=p>]</span> <span class=o>=</span> <span class=n>old_balances</span><span class=p>[</span><span class=n>meta_i</span><span class=p>]</span> <span class=o>+</span> <span class=n>dx_w_fee</span>
        <span class=c1># When rounding errors happen, we undercharge admin fee in favor of LP</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>balances</span><span class=p>[</span><span class=n>meta_j</span><span class=p>]</span> <span class=o>=</span> <span class=n>old_balances</span><span class=p>[</span><span class=n>meta_j</span><span class=p>]</span> <span class=o>-</span> <span class=n>dy</span> <span class=o>-</span> <span class=n>dy_admin_fee</span>

        <span class=c1># Withdraw from the base pool if needed</span>
        <span class=k>if</span> <span class=n>base_j</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>:</span>
            <span class=n>out_amount</span><span class=p>:</span> <span class=n>uint256</span> <span class=o>=</span> <span class=n>ERC20</span><span class=p>(</span><span class=n>output_coin</span><span class=p>)</span><span class=o>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
            <span class=n>Curve</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>)</span><span class=o>.</span><span class=n>remove_liquidity_one_coin</span><span class=p>(</span><span class=n>dy</span><span class=p>,</span> <span class=n>base_j</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
            <span class=n>dy</span> <span class=o>=</span> <span class=n>ERC20</span><span class=p>(</span><span class=n>output_coin</span><span class=p>)</span><span class=o>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-</span> <span class=n>out_amount</span>

        <span class=k>assert</span> <span class=n>dy</span> <span class=o>&gt;=</span> <span class=n>min_dy</span><span class=p>,</span> <span class=s2>&quot;Too few coins in result&quot;</span>

    <span class=k>else</span><span class=p>:</span>
        <span class=c1># If both are from the base pool</span>
        <span class=n>dy</span> <span class=o>=</span> <span class=n>ERC20</span><span class=p>(</span><span class=n>output_coin</span><span class=p>)</span><span class=o>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
        <span class=n>Curve</span><span class=p>(</span><span class=n>_base_pool</span><span class=p>)</span><span class=o>.</span><span class=n>exchange</span><span class=p>(</span><span class=n>base_i</span><span class=p>,</span> <span class=n>base_j</span><span class=p>,</span> <span class=n>dx_w_fee</span><span class=p>,</span> <span class=n>min_dy</span><span class=p>)</span>
        <span class=n>dy</span> <span class=o>=</span> <span class=n>ERC20</span><span class=p>(</span><span class=n>output_coin</span><span class=p>)</span><span class=o>.</span><span class=n>balanceOf</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-</span> <span class=n>dy</span>

    <span class=c1># &quot;safeTransfer&quot; which works for ERC20s which return bool or not</span>
    <span class=n>_response</span> <span class=o>=</span> <span class=n>raw_call</span><span class=p>(</span>
        <span class=n>output_coin</span><span class=p>,</span>
        <span class=n>concat</span><span class=p>(</span>
            <span class=n>method_id</span><span class=p>(</span><span class=s2>&quot;transfer(address,uint256)&quot;</span><span class=p>),</span>
            <span class=n>convert</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>sender</span><span class=p>,</span> <span class=n>bytes32</span><span class=p>),</span>
            <span class=n>convert</span><span class=p>(</span><span class=n>dy</span><span class=p>,</span> <span class=n>bytes32</span><span class=p>),</span>
        <span class=p>),</span>
        <span class=n>max_outsize</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>
    <span class=p>)</span>  <span class=c1># dev: failed transfer</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>_response</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
        <span class=k>assert</span> <span class=n>convert</span><span class=p>(</span><span class=n>_response</span><span class=p>,</span> <span class=nb>bool</span><span class=p>)</span>  <span class=c1># dev: failed transfer</span>
    <span class=c1># end &quot;safeTransfer&quot;</span>

    <span class=n>log</span> <span class=n>TokenExchangeUnderlying</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>sender</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>dx</span><span class=p>,</span> <span class=n>j</span><span class=p>,</span> <span class=n>dy</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>dy</span>
</code></pre></div> </details> <div class="tabbed-set tabbed-alternate" data-tabs=7:1><input checked=checked id=__tabbed_7_1 name=__tabbed_7 type=radio><div class=tabbed-labels><label for=__tabbed_7_1>Example</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code>&gt;&gt;&gt; lending_pool.exchange_underlying<span class=o>()</span>
todo: console output
</code></pre></div> </div> </div> </div> </div> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2022-04-26T15:48:34+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2022-04-26</span> </small> </div> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top data-md-state=hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../lending_pools/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Lending Pools" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Lending Pools </div> </div> </a> <a href=../admin_pool_settings/ class="md-footer__link md-footer__link--next" aria-label="Next: Admin Controls" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Admin Controls </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["content.code.annotate", "content.tabs.link", "navigation.expand", "navigation.indexes", "navigation.instant", "navigation.sections", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.5e67fbfe.min.js"}</script> <script src=../../../assets/javascripts/bundle.e87a5f81.min.js></script> <script src=../../../js/timeago.min.js></script> <script src=../../../js/timeago_mkdocs_material.js></script> </body> </html>